<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTM ‚Äì Syst√®me de Points (final corrig√©)</title>

  <!-- UI & React -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Excel/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* Filigrane */
    #btm-watermark{
      position:fixed;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;z-index:0;
      background-repeat:no-repeat;background-position:center;background-size:contain;
      opacity:var(--wm-opacity,.2);transform:scale(var(--wm-scale,1));filter:saturate(.9)
    }
    #root{position:relative;z-index:1}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
  <div id="btm-watermark" aria-hidden="true"></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, memo } = React;

    const K = {
      P:'btm_participants',      // donn√©es participants
      A:'btm_admin_password',    // mot de passe admin
      L:'btm_logo_dataurl',      // logo filigrane
      O:'btm_logo_opacity',      // opacit√© filigrane
      S:'btm_logo_scale',        // taille filigrane
      N:'btm_new_name'           // champ "nouveau nom" persistant
    };

    // Init MDP admin par d√©faut
    if (!localStorage.getItem(K.A)) localStorage.setItem(K.A,'admin123');

    /* ===================== Filigrane ===================== */
    function useWatermark(){
      const [logo,setLogo]=useState(localStorage.getItem(K.L)||'');
      const [opacity,setOpacity]=useState(parseFloat(localStorage.getItem(K.O)||'0.2'));
      const [scale,setScale]=useState(parseFloat(localStorage.getItem(K.S)||'1'));
      useEffect(()=>{
        const wm=document.getElementById('btm-watermark');
        if(wm){
          wm.style.setProperty('--wm-opacity',opacity);
          wm.style.setProperty('--wm-scale',scale);
          wm.style.backgroundImage = logo ? `url('${logo}')` : 'none';
        }
      },[logo,opacity,scale]);
      return {
        logo,opacity,scale,
        saveLogo:(d)=>{setLogo(d);localStorage.setItem(K.L,d)},
        saveOpacity:(v)=>{setOpacity(v);localStorage.setItem(K.O,String(v))},
        saveScale:(v)=>{setScale(v);localStorage.setItem(K.S,String(v))}
      };
    }

    /* ===================== Tri & Rangs (ex √¶quo) ===================== */
    function sortParticipants(list, sortPrimary, sortDir) {
      // sortPrimary: 'points' | 'name'
      // sortDir: 'desc' | 'asc'
      return [...list].sort((a, b) => {
        if (sortPrimary === 'name') {
          const s = a.name.localeCompare(b.name);
          if (s !== 0) return sortDir === 'asc' ? s : -s;
          // secondaire: points DESC
          if (b.points !== a.points) return b.points - a.points;
          return a.name.localeCompare(b.name);
        } else {
          // principal: points
          if (b.points !== a.points)
            return sortDir === 'desc' ? (b.points - a.points) : (a.points - b.points);
          // secondaire: nom ASC
          return a.name.localeCompare(b.name);
        }
      });
    }

    function computeRanks(list, sortPrimary = 'points', sortDir = 'desc') {
      const sorted = sortParticipants(list, sortPrimary, sortDir);
      const out = [];
      let lastPts = null, lastRank = 0;
      sorted.forEach((p, i) => {
        const r = (p.points === lastPts) ? lastRank : (i + 1);
        out.push({ ...p, _rank: r });
        lastPts = p.points;
        lastRank = r;
      });
      return out;
    }

    const rankEmoji=(r)=>r===1?'ü•á':r===2?'ü•à':r===3?'ü•â':`#${r}`;
    const rankColor=(r)=>r===1?'from-yellow-400 to-yellow-600':r===2?'from-gray-300 to-gray-500':r===3?'from-orange-400 to-orange-600':'from-blue-400 to-blue-600';

    /* ===================== Barre d'ajout ===================== */
    const AddBar = memo(function AddBar({onAdd}){
      const [name,setName]=useState(localStorage.getItem(K.N)||'');
      const inputRef=useRef(null);
      useEffect(()=>{
        const el=inputRef.current;
        if(el && document.activeElement!==el && name && !window._btm_user_blurred){
          el.focus({preventScroll:true});
          const len=el.value.length; el.setSelectionRange(len,len);
        }
      });
      useEffect(()=>{ localStorage.setItem(K.N,name); },[name]);
      const addNow=()=>{ const trimmed=name.trim(); if(!trimmed) return;
        onAdd(trimmed); setName(''); localStorage.removeItem(K.N);
        requestAnimationFrame(()=>{ inputRef.current?.focus({preventScroll:true}); });
      };
      return (
        <div className="bg-white rounded-2xl shadow-xl p-5 sm:p-6 mb-4 sm:mb-6">
          <h2 className="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">‚ûï Ajouter un Participant</h2>
          <div className="flex flex-col sm:flex-row gap-3">
            <input ref={inputRef} type="text" autoComplete="off" autoCorrect="off" spellCheck="false" value={name}
              onChange={e=>setName(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') addNow(); }}
              onBlur={()=>{ window._btm_user_blurred=true; }} onFocus={()=>{ window._btm_user_blurred=false; }}
              placeholder="Nom du participant"
              className="flex-1 px-3 sm:px-4 py-2.5 sm:py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" />
            <div className="flex flex-wrap gap-2">
              <button onClick={addNow}
                className="bg-blue-600 text-white px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                Ajouter
              </button>
            </div>
          </div>
        </div>
      );
    });

    /* ===================== App ===================== */
    function App(){
      const [mode,setMode]=useState(null);       // null | 'admin' | 'participant'
      const [pwd,setPwd]=useState('');
      const [showLogin,setShowLogin]=useState(true);
      const [tab,setTab]=useState('participants');

      const [participants,setParticipants]=useState(()=>{
        const s=localStorage.getItem(K.P); if(!s) return [];
        try{return JSON.parse(s)}catch{return []}
      });

      // Tri
      const [sortPrimary, setSortPrimary] = useState('points'); // 'points' | 'name'
      const [sortDir, setSortDir] = useState('desc');           // 'desc' | 'asc'

      const [sel,setSel]=useState(null);
      const [showAdd,setShowAdd]=useState(false);
      const [lastUpdate,setLastUpdate]=useState(new Date());
      const {logo,opacity,scale,saveLogo,saveOpacity,saveScale}=useWatermark();

      // √âdition avanc√©e
      const [showEdit, setShowEdit] = useState(false);
      const [edit, setEdit] = useState({
        id: null, name: '', fast: 0, slow: 0, chal: 0, points: 0
      });
      const recomputePoints = (e) => (5 * (e.fast || 0)) + (3 * (e.slow || 0)) + (10 * (e.chal || 0));

      const openEdit = (p) => {
        const draft = {
          id: p.id,
          name: p.name,
          fast: p.fastAnswers || 0,
          slow: p.slowAnswers || 0,
          chal: p.challenges  || 0,
        };
        setEdit({ ...draft, points: recomputePoints(draft) });
        setShowEdit(true);
      };
      const saveEdit = () => {
        const name = (edit.name || '').trim();
        const fast = Math.max(0, parseInt(edit.fast, 10) || 0);
        const slow = Math.max(0, parseInt(edit.slow, 10) || 0);
        const chal = Math.max(0, parseInt(edit.chal, 10) || 0);
        const pts  = (5 * fast) + (3 * slow) + (10 * chal);
        if (!name) return alert('Le nom ne peut pas √™tre vide.');
        setParticipants(ps =>
          ps.map(x => x.id === edit.id
            ? { ...x, name, fastAnswers: fast, slowAnswers: slow, challenges: chal, points: pts }
            : x
          )
        );
        setShowEdit(false);
      };

      // Sauvegarde auto
      useEffect(()=>{
        try{ localStorage.setItem(K.P, JSON.stringify(participants)); }catch(e){}
        setLastUpdate(new Date());
      },[participants]);

      useEffect(()=>{
        const h=()=>{ try{ localStorage.setItem(K.P, JSON.stringify(participants)); }catch(e){} };
        window.addEventListener('beforeunload',h); return ()=>window.removeEventListener('beforeunload',h);
      },[participants]);

      // Participant : rafra√Æchissement auto 10s
      useEffect(()=>{
        if(mode!=='participant') return;
        const iv=setInterval(()=>{
          const s=localStorage.getItem(K.P);
          if(s){ try{ setParticipants(JSON.parse(s)); setLastUpdate(new Date()); }catch(e){} }
        },10000);
        return ()=>clearInterval(iv);
      },[mode]);

      // Auth
      const login=(as)=>{
        if(as==='admin'){
          const a=localStorage.getItem(K.A)||'admin123';
          if(pwd===a){ setMode('admin'); setShowLogin(false); setPwd(''); }
          else alert('‚ùå Mot de passe incorrect !');
        } else {
          setMode('participant'); setShowLogin(false); setTab('view');
        }
      };
      const logout=()=>{ setMode(null); setShowLogin(true); setPwd(''); };

      // CRUD / Points
      const addParticipant=(name)=>{
        setParticipants(p=>[...p,{
          id:Date.now()+Math.floor(Math.random()*1e5),
          name,points:0,fastAnswers:0,slowAnswers:0,challenges:0
        }]);
      };
      const del=(id)=>{ if(confirm('Supprimer ce participant ?')) setParticipants(participants.filter(p=>p.id!==id)); };
      const addPts=(id,t)=>{
        setParticipants(ps=>ps.map(p=>{
          if(p.id!==id) return p;
          if(t==='fast') return {...p,points:p.points+5,fastAnswers:p.fastAnswers+1};
          if(t==='slow') return {...p,points:p.points+3,slowAnswers:p.slowAnswers+1};
          if(t==='challenge') return {...p,points:p.points+10,challenges:p.challenges+1};
          return p;
        }));
        setShowAdd(false); setSel(null);
      };

      // Copier / Export CSV / Export PDF
      const copyClip=()=>{
        const rows=computeRanks(participants, sortPrimary, sortDir)
          .map(p=>`${p._rank}\t${p.name}\t${p.points}\t${p.fastAnswers}\t${p.slowAnswers}\t${p.challenges}`);
        const text=['Rang\tNom\tPoints Total\tR√©ponses Rapides (5pts)\tR√©ponses Tardives (3pts)\tD√©fis Pratiques (10pts)',...rows].join('\n');
        navigator.clipboard.writeText(text).then(()=>alert('‚úÖ Donn√©es copi√©es !')).catch(()=>alert('‚ùå Erreur lors de la copie.'));
      };
      const exportCSV=()=>{
        const BOM = '\uFEFF';
        const headers=['Rang','Nom','Points Total','R√©ponses Rapides (5pts)','R√©ponses Tardives (3pts)','D√©fis Pratiques (10pts)'];
        const rows=computeRanks(participants, sortPrimary, sortDir)
          .map(p=>[p._rank,`"${p.name}"`,p.points,p.fastAnswers,p.slowAnswers,p.challenges]);
        const csv=BOM+[headers,...rows].map(r=>r.join(';')).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`classement_btm_${new Date().toLocaleDateString('fr-FR')}.csv`; a.click();
        URL.revokeObjectURL(url);
      };
      const exportPDF = async () => {
        try {
          const node = document.getElementById('btm-report');
          if (!node) return alert('Section √† exporter introuvable.');

          const canvas = await html2canvas(node, {
            scale: 2,
            useCORS: true,
            windowWidth: node.scrollWidth,
          });

          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          const imgWidth = pageWidth;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          if (imgHeight <= pageHeight) {
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          } else {
            const ratio = canvas.width / imgWidth;        // px par mm
            const pagePixelHeight = pageHeight * ratio;   // hauteur page en px
            let position = 0;
            let heightLeft = canvas.height;

            const pageCanvas = document.createElement('canvas');
            const ctx = pageCanvas.getContext('2d');

            while (heightLeft > 0) {
              const sliceHeightPx = Math.min(pagePixelHeight, canvas.height - position);
              pageCanvas.width = canvas.width;
              pageCanvas.height = sliceHeightPx;

              ctx.clearRect(0, 0, pageCanvas.width, pageCanvas.height);
              ctx.drawImage(canvas, 0, position, canvas.width, sliceHeightPx, 0, 0, pageCanvas.width, pageCanvas.height);
              const pageImg = pageCanvas.toDataURL('image/png');

              if (position === 0) {
                pdf.addImage(pageImg, 'PNG', 0, 0, imgWidth, sliceHeightPx / ratio);
              } else {
                pdf.addPage();
                pdf.addImage(pageImg, 'PNG', 0, 0, imgWidth, sliceHeightPx / ratio);
              }

              position += sliceHeightPx;
              heightLeft -= sliceHeightPx;
            }
          }

          pdf.save(`classement_btm_${new Date().toLocaleDateString('fr-FR')}.pdf`);
        } catch (e) {
          console.error(e);
          alert('‚ùå √âchec de g√©n√©ration du PDF.');
        }
      };

      // Import / Ajout group√©
      const handleCSVText = (text) => {
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (!lines.length) return;
        const head = lines[0].split(/;|,|\t/).map(h => h.trim());
        const rows = lines.slice(1).map(l => {
          const c = l.split(/;|,|\t/);
          const o = {};
          head.forEach((h,i)=> o[h] = (c[i]||'').trim());
          return o;
        });
        upsert(rows);
      };

      const upsert = (rows) => {
        const by = new Map(participants.map(p => [p.name.toLowerCase(), p]));
        const norm = (v, d=0) => isNaN(parseInt(v)) ? d : parseInt(v);

        rows.forEach(r => {
          const name = (r.name || r.Nom || r.Participant || '').toString().trim();
          if (!name) return;
          const ex = by.get(name.toLowerCase());
          const obj = {
            id: ex ? ex.id : Date.now() + Math.floor(Math.random()*1e5),
            name,
            points:      norm(r.points ?? r.Points ?? r['Points Total'], ex ? ex.points : 0),
            fastAnswers: norm(r.fastAnswers ?? r.Rapides ?? r['R√©ponses Rapides (5pts)'], ex ? ex.fastAnswers : 0),
            slowAnswers: norm(r.slowAnswers ?? r.Tardives ?? r['R√©ponses Tardives (3pts)'], ex ? ex.slowAnswers : 0),
            challenges:  norm(r.challenges ?? r['D√©fis'] ?? r['D√©fis Pratiques (10pts)'], ex ? ex.challenges : 0),
          };
          // recalcul si d√©tails fournis
          const hasDetailed = ('Rapides' in r) || ('Tardives' in r) || ('D√©fis' in r) ||
                              ('D√©fis Pratiques (10pts)' in r) ||
                              ('fastAnswers' in r) || ('slowAnswers' in r) || ('challenges' in r);
          if (hasDetailed) obj.points = (obj.fastAnswers*5) + (obj.slowAnswers*3) + (obj.challenges*10);
          by.set(name.toLowerCase(), obj);
        });

        setParticipants([...by.values()]);
        alert('‚úÖ Import termin√©.');
      };

      const importFile = async (file) => {
        if (!file) return;
        const ext = file.name.toLowerCase().split('.').pop();
        const buf = await file.arrayBuffer();
        if (ext === 'csv' || ext === 'txt') {
          const text = new TextDecoder('utf-8').decode(new Uint8Array(buf));
          handleCSVText(text);
        } else if (ext === 'xlsx' || ext === 'xls') {
          const wb = XLSX.read(buf, { type: 'array' });
          const sh = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sh, { defval:'' });
          upsert(json);
        } else {
          alert('Format non support√©. Utilisez CSV/XLSX.');
        }
      };

      const importGSheet = async () => {
        const url = prompt("Collez l'URL CSV public de Google Sheets :");
        if (!url) return;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const text = await res.text();
          handleCSVText(text);
        } catch (e) {
          alert('‚ùå √âchec CSV. Publiez la feuille en CSV et rendez-la publique.');
        }
      };

      const bulkAddNames = (raw) => {
        const names = raw.split(/\r?\n|,|;|\t/).map(s => s.trim()).filter(Boolean);
        if (!names.length) return alert('Liste vide.');
        setParticipants(prev => ([
          ...prev,
          ...names.map(name => ({
            id: Date.now() + Math.floor(Math.random()*1e5),
            name,
            points: 0, fastAnswers: 0, slowAnswers: 0, challenges: 0
          }))
        ]));
        alert(`‚úÖ ${names.length} participant(s) ajout√©(s).`);
      };

      /* ===================== En-t√™te + L√©gende ===================== */
      const HeaderLegend=({right})=>(
        <div className="bg-white rounded-3xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
          <div className="flex items-center justify-between flex-wrap gap-3 sm:gap-4">
            <div className="flex items-center gap-3 sm:gap-4">
              <div className="text-yellow-500 text-3xl sm:text-4xl">üèÜ</div>
              <div>
                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">
                  {mode==='admin'?'üîß Mode Administrateur':'üë• Mode Participant (lecture seule)'}
                </h1>
                <p className="text-gray-600 text-sm sm:text-base">Formation BTM - BiT Technologie</p>
                {mode==='participant'&&(
                  <p className="text-xs sm:text-sm text-blue-600 mt-1">
                    Actualisation auto 10s ‚Äî derni√®re : {lastUpdate.toLocaleTimeString('fr-FR')}
                  </p>
                )}
              </div>
            </div>
            <div className="flex gap-2 flex-wrap">{right}</div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 mt-4 sm:mt-6">
            <div className="flex items-center gap-3 bg-blue-50 p-3 sm:p-4 rounded-lg">
              <span className="text-blue-600 text-xl">‚è±Ô∏è</span>
              <div>
                <div className="font-bold text-blue-800">5 points</div>
                <div className="text-sm text-gray-600">R√©ponse rapide (&lt;30min)</div>
              </div>
            </div>
            <div className="flex items-center gap-3 bg-green-50 p-3 sm:p-4 rounded-lg">
              <span className="text-green-600 text-xl">‚úîÔ∏è</span>
              <div>
                <div className="font-bold text-green-800">3 points</div>
                <div className="text-sm text-gray-600">R√©ponse tardive</div>
              </div>
            </div>
            <div className="flex items-center gap-3 bg-purple-50 p-3 sm:p-4 rounded-lg">
              <span className="text-purple-600 text-xl">üé¨</span>
              <div>
                <div className="font-bold text-purple-800">10 points</div>
                <div className="text-sm text-gray-600">D√©fi pratique r√©ussi</div>
              </div>
            </div>
          </div>
        </div>
      );

      /* ===================== UI Tri (boutons) ===================== */
      const SortButtons = () => (
        <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
          <button
            className={`px-3 py-2 rounded ${sortPrimary==='points' ? 'bg-white font-semibold' : ''}`}
            title="Trier par points (desc), puis nom (asc)"
            onClick={() => { setSortPrimary('points'); setSortDir('desc'); }}
          >Points ‚Üì</button>
          <button
            className={`px-3 py-2 rounded ${sortPrimary==='name' ? 'bg-white font-semibold' : ''}`}
            title="Trier par nom (asc), puis points (desc)"
            onClick={() => { setSortPrimary('name'); setSortDir('asc'); }}
          >Nom ‚Üë</button>
        </div>
      );

      /* ===================== Ent√™tes droites ===================== */
      const headerRightParticipant=(<>
        <SortButtons />
        <button onClick={()=>{
          const s=localStorage.getItem(K.P);
          if(s){ try{ setParticipants(JSON.parse(s)); setLastUpdate(new Date()); alert('‚úÖ Donn√©es actualis√©es !'); }catch(e){} }
        }} className="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm sm:text-base">
          üîÑ Actualiser
        </button>
        <button onClick={logout}
          className="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm sm:text-base">
          üö™ D√©connexion
        </button>
      </>);

      const headerRightAdmin=(<>
        <SortButtons />
        <button onClick={()=>setTab('participants')}
          className={`px-3 sm:px-4 py-2 rounded-lg ${tab==='participants'?'bg-blue-600 text-white':'bg-gray-100'}`}>
          Participants
        </button>
        <button onClick={()=>setTab('import')}
          className={`px-3 sm:px-4 py-2 rounded-lg ${tab==='import'?'bg-blue-600 text-white':'bg-gray-100'}`}>
          Import
        </button>
        <button onClick={()=>setTab('settings')}
          className={`px-3 sm:px-4 py-2 rounded-lg ${tab==='settings'?'bg-blue-600 text-white':'bg-gray-100'}`}>
          Param√®tres
        </button>
        <button onClick={copyClip}
          className="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-700 transition">üìã Copier</button>
        <button onClick={exportCSV}
          className="bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-green-700 transition">‚¨áÔ∏è CSV</button>
        <button onClick={exportPDF}
          className="bg-emerald-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-emerald-700 transition">üßæ PDF</button>
        <button onClick={reset}
          className="bg-red-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-red-700 transition">üóëÔ∏è Reset</button>
        <button onClick={logout}
          className="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 transition">üö™ D√©connexion</button>
      </>);

      /* ===================== Blocs podium/classement/stats ===================== */
      const ranked=computeRanks(participants, sortPrimary, sortDir);
      const podGroups=[1,2,3].map(r=>ranked.filter(p=>p._rank===r));

      function LeaderboardBlocks({readonly}){
        return (<>
          {!readonly && <AddBar onAdd={addParticipant} />}

          {ranked.length>0 && (
            <div className="bg-white rounded-2xl shadow-xl p-5 sm:p-6 mb-4 sm:mb-6">
              <h2 className="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üèÜ Podium (ex √¶quo g√©r√©s)</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
                {[1,2,3].map((r,idx)=>(
                  <div key={r} className={`p-4 rounded-xl ${
                    r===1?'bg-yellow-50 border-2 border-yellow-300':
                    r===2?'bg-gray-50 border-2 border-gray-300':
                           'bg-orange-50 border-2 border-orange-300'
                  }`}>
                    <div className="text-2xl mb-2">{rankEmoji(r)}</div>
                    {podGroups[idx].length===0?(
                      <div className="text-gray-500">‚Äî</div>
                    ):podGroups[idx].map(p=>(
                      <div key={p.id} className="flex items-center justify-between py-1">
                        <div className="font-semibold text-gray-800">{p.name}</div>
                        <div className="text-gray-900 font-bold">{p.points} pts</div>
                      </div>
                    ))}
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="bg-white rounded-2xl shadow-xl overflow-hidden mb-4 sm:mb-6">
            <div className="p-4 sm:p-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
              <h2 className="text-xl sm:text-2xl font-bold">üìà Classement Complet (ex √¶quo g√©r√©s)</h2>
            </div>

            <div className="px-4 sm:px-6 py-2 bg-white text-sm text-gray-600">
              Tri actuel : <b>
                {sortPrimary === 'points' ? 'Points ‚Üì, Nom ‚Üë (secondaire)' : 'Nom ‚Üë, Points ‚Üì (secondaire)'}
              </b>
            </div>

            {ranked.length===0?(
              <div className="p-10 sm:p-12 text-center text-gray-500">
                <div className="text-5xl sm:text-6xl mb-2 opacity-30">üèÜ</div>
                <p className="text-lg sm:text-xl">Aucun participant</p>
              </div>
            ):(
              <div className="overflow-x-auto">
                <table className="w-full text-sm sm:text-base">
                  <thead className="bg-gray-100 text-left">
                    <tr>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 font-bold text-gray-700">Rang</th>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 font-bold text-gray-700">
                        Participant {sortPrimary==='name' && <span title="Tri principal">‚Üë</span>}
                      </th>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 text-center font-bold text-gray-700">
                        Points {sortPrimary==='points' && <span title="Tri principal">‚Üì</span>}
                      </th>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 text-center font-bold text-gray-700">Rapides</th>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 text-center font-bold text-gray-700">Tardives</th>
                      <th className="px-4 sm:px-6 py-3 sm:py-4 text-center font-bold text-gray-700">D√©fis</th>
                      {!readonly&&<th className="px-4 sm:px-6 py-3 sm:py-4 text-center font-bold text-gray-700">Actions</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {ranked.map(p=>(
                      <tr key={p.id} className={`border-t hover:bg-gray-50 ${p._rank<=3?'bg-yellow-50':''}`}>
                        <td className="px-4 sm:px-6 py-3 sm:py-4">
                          <span className="text-xl sm:text-2xl font-bold">{rankEmoji(p._rank)}</span>
                        </td>
                        <td className="px-4 sm:px-6 py-3 sm:py-4">
                          <span className="font-semibold text-gray-800">{p.name}</span>
                        </td>
                        <td className="px-4 sm:px-6 py-3 sm:py-4 text-center">
                          <span className={`inline-block px-3 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold text-white bg-gradient-to-r ${rankColor(p._rank)}`}>{p.points}</span>
                        </td>
                        <td className="px-4 sm:px-6 py-3 sm:py-4 text-center">
                          <span className="text-blue-600 font-semibold">{p.fastAnswers} √ó 5pts</span>
                        </td>
                        <td className="px-4 sm:px-6 py-3 sm:py-4 text-center">
                          <span className="text-green-600 font-semibold">{p.slowAnswers} √ó 3pts</span>
                        </td>
                        <td className="px-4 sm:px-6 py-3 sm:py-4 text-center">
                          <span className="text-purple-600 font-semibold">{p.challenges} √ó 10pts</span>
                        </td>

                        {!readonly&&(
                          <td className="px-4 sm:px-6 py-3 sm:py-4">
                            <div className="flex gap-2 justify-center">
                              <button
                                onClick={()=>{setSel(p.id); setShowAdd(true)}}
                                className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition"
                                title="Ajouter des points"
                              >‚ûï</button>

                              {/* Bouton libell√© texte ‚Äú√âditer‚Äù */}
                              <button
                                onClick={()=>openEdit(p)}
                                className="bg-amber-500 text-white px-3 py-2 rounded-lg hover:bg-amber-600 transition"
                                title="Modifier le nom et les compteurs (recalcule le total)"
                              >√âditer</button>

                              <button
                                onClick={()=>del(p.id)}
                                className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition"
                                title="Supprimer"
                              >üóëÔ∏è</button>
                            </div>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {participants.length>0 && (
            <div className="bg-white rounded-2xl shadow-xl p-5 sm:p-6">
              <h2 className="text-lg sm:text-xl font-bold text-gray-800 mb-3">üìä Statistiques Globales</h2>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                <div className="bg-blue-50 p-3 sm:p-4 rounded-lg text-center">
                  <div className="text-2xl sm:text-3xl font-bold text-blue-600">{participants.length}</div>
                  <div className="text-xs sm:text-sm text-gray-600">Participants</div>
                </div>
                <div className="bg-green-50 p-3 sm:p-4 rounded-lg text-center">
                  <div className="text-2xl sm:text-3xl font-bold text-green-600">
                    {participants.reduce((s,p)=>s+p.points,0)}
                  </div>
                  <div className="text-xs sm:text-sm text-gray-600">Points Totaux</div>
                </div>
                <div className="bg-purple-50 p-3 sm:p-4 rounded-lg text-center">
                  <div className="text-2xl sm:text-3xl font-bold text-purple-600">
                    {participants.reduce((s,p)=>s+p.challenges,0)}
                  </div>
                  <div className="text-xs sm:text-sm text-gray-600">D√©fis R√©alis√©s</div>
                </div>
                <div className="bg-yellow-50 p-3 sm:p-4 rounded-lg text-center">
                  <div className="text-2xl sm:text-3xl font-bold text-yellow-600">
                    {participants.length>0?Math.round(participants.reduce((s,p)=>s+p.points,0)/participants.length):0}
                  </div>
                  <div className="text-xs sm:text-sm text-gray-600">Moyenne Points</div>
                </div>
              </div>
            </div>
          )}
        </>);
      }

      /* ===================== Login ===================== */
      if(showLogin){
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 max-w-md w-full">
              <div className="text-center mb-6 sm:mb-8">
                <div className="bg-gradient-to-br from-yellow-400 to-yellow-600 p-3 sm:p-4 rounded-full inline-block mb-4 text-white text-3xl sm:text-4xl">üèÜ</div>
                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-1 sm:mb-2">Syst√®me de Points</h1>
                <p className="text-gray-600 text-sm sm:text-base">Formation Windows 11 - BiT Technologie</p>
              </div>
              <div className="space-y-4">
                <div className="bg-blue-50 p-4 sm:p-6 rounded-2xl border-2 border-blue-200">
                  <div className="flex items-center gap-2 sm:gap-3 mb-3">
                    <span className="text-blue-600 text-lg sm:text-xl">üîí</span>
                    <h3 className="font-bold text-base sm:text-lg text-gray-800">Connexion Administrateur</h3>
                  </div>
                  <input type="password" value={pwd} onChange={e=>setPwd(e.target.value)} onKeyDown={e=>e.key==='Enter'&&login('admin')}
                         placeholder="Mot de passe admin"
                         className="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 rounded-lg mb-3 focus:border-blue-500 focus:outline-none" />
                  <button onClick={()=>login('admin')} className="w-full bg-blue-600 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                    Se connecter en Admin
                  </button>
                  <p className="text-xs text-gray-500 mt-2 text-center">Par d√©faut : <b>admin123</b> (modifiable dans Param√®tres)</p>
                </div>

                <div className="bg-green-50 p-4 sm:p-6 rounded-2xl border-2 border-green-200">
                  <div className="flex items-center gap-2 sm:gap-3 mb-3">
                    <span className="text-green-600 text-lg sm:text-xl">üëÅÔ∏è</span>
                    <h3 className="font-bold text-base sm:text-lg text-gray-800">Mode Participant</h3>
                  </div>
                  <p className="text-sm text-gray-600 mb-3">Tout est visible en lecture seule (podium, classement, stats).</p>
                  <button onClick={()=>login('participant')} className="w-full bg-green-600 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                    Entrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /* ===================== Participant ===================== */
      if (mode==='participant'){
        const right = headerRightParticipant;
        return (
          <div className="min-h-screen p-3 sm:p-4">
            <div className="max-w-6xl mx-auto">
              <HeaderLegend right={right} />
              <div id="btm-report">
                <LeaderboardBlocks readonly />
              </div>
            </div>
          </div>
        );
      }

      /* ===================== Admin ===================== */
      return (
        <div className="min-h-screen p-3 sm:p-4">
          <div className="max-w-6xl mx-auto">
            <HeaderLegend right={headerRightAdmin} />

            {tab==='participants' && (
              <div id="btm-report">
                <LeaderboardBlocks readonly={false} />
              </div>
            )}

            {tab==='import' && (
              <div className="bg-white rounded-2xl shadow-xl p-5 sm:p-6 mb-4 sm:mb-6">
                <h2 className="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">üì• Ajout / Import en groupe</h2>
                <div className="grid md:grid-cols-2 gap-4 sm:gap-6">
                  <div className="p-4 rounded-lg border-2 border-dashed">
                    <p className="mb-2 font-semibold">Importer un fichier CSV/XLSX</p>
                    <input type="file" accept=".csv,.txt,.xlsx,.xls" onChange={e=>importFile(e.target.files[0])} />
                    <p className="text-sm text-gray-600 mt-2">
                      Colonnes reconnues : <code>Nom</code>/<code>Participant</code> (obligatoire),
                      <code>Points</code>, <code>Rapides</code>, <code>Tardives</code>, <code>D√©fis</code> (facultatives).
                    </p>
                  </div>
                  <div className="p-4 rounded-lg border-2 border-dashed">
                    <p className="mb-2 font-semibold">Importer via Google Sheets (CSV public)</p>
                    <button onClick={importGSheet} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Coller l'URL CSV</button>
                    <p className="text-sm text-gray-600 mt-2">Sheets ‚Üí Fichier ‚Üí Publier sur le Web ‚Üí Format CSV ‚Üí lien public.</p>
                  </div>
                </div>

                <div className="mt-6 p-4 rounded-lg border">
                  <p className="mb-2 font-semibold">Ajouter une liste de noms (coller)</p>
                  <textarea id="bulkNames" className="w-full h-36 p-3 border rounded" placeholder="Un nom par ligne
OU s√©par√©s par , ; ou tabulation"></textarea>
                  <div className="mt-3 flex gap-2">
                    <button className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                      onClick={()=>{ const raw=document.getElementById('bulkNames').value||''; bulkAddNames(raw); document.getElementById('bulkNames').value=''; }}>
                      ‚ûï Ajouter ces participants
                    </button>
                  </div>
                </div>
              </div>
            )}

            {tab==='settings' && (
              <div className="bg-white rounded-2xl shadow-xl p-5 sm:p-6 mb-4 sm:mb-6 space-y-6">
                <h2 className="text-lg sm:text-xl font-bold text-gray-800">‚öôÔ∏è Param√®tres</h2>
                <div className="grid md:grid-cols-2 gap-4 sm:gap-6">

                  <div className="p-4 rounded-lg border">
                    <h3 className="font-semibold mb-2">Mot de passe administrateur</h3>
                    <label className="block text-sm text-gray-600 mb-1">Nouveau mot de passe</label>
                    <input id="newpass" type="password" className="w-full px-3 py-2 border rounded mb-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                    <label className="block text-sm text-gray-600 mb-1">Confirmer</label>
                    <input id="newpass2" type="password" className="w-full px-3 py-2 border rounded mb-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                    <button className="bg-blue-600 text-white px-4 py-2 rounded"
                      onClick={()=>{ const p1=document.getElementById('newpass').value; const p2=document.getElementById('newpass2').value;
                        if(!p1) return alert('Mot de passe vide.'); if(p1!==p2) return alert('Les mots de passe ne correspondent pas.');
                        localStorage.setItem(K.A,p1); alert('‚úÖ Mot de passe mis √† jour.');
                        document.getElementById('newpass').value=''; document.getElementById('newpass2').value=''; }}>
                      Enregistrer
                    </button>
                    <p className="text-xs text-gray-500 mt-2">Stock√© localement (navigateur courant).</p>
                  </div>

                  <div className="p-4 rounded-lg border">
                    <h3 className="font-semibold mb-2">Logo BIT TECHNOLOGIE MALI (filigrane)</h3>
                    <input type="file" accept="image/*"
                      onChange={(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>saveLogo(r.result); r.readAsDataURL(f); }} />
                    <div className="mt-3">
                      <label className="block text-sm text-gray-600">Opacit√© : {opacity.toFixed(2)}</label>
                      <input type="range" min="0" max="1" step="0.05" value={opacity} onChange={e=>saveOpacity(parseFloat(e.target.value))} className="w-full"/>
                    </div>
                    <div className="mt-3">
                      <label className="block text-sm text-gray-600">Taille (scale) : {scale.toFixed(2)}</label>
                      <input type="range" min="0.2" max="2" step="0.05" value={scale} onChange={e=>saveScale(parseFloat(e.target.value))} className="w-full"/>
                    </div>
                    <div className="mt-3">
                      <button className="px-3 py-2 rounded bg-gray-100" onClick={()=>{saveLogo(''); alert('Filigrane retir√©.')}}>
                        Retirer le filigrane
                      </button>
                    </div>
                    <p className="text-xs text-gray-500 mt-2">Le filigrane est stock√© localement (base64).</p>
                  </div>

                </div>
              </div>
            )}

            {/* Modal points */}
            {mode==='admin' && showAdd && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
                <div className="bg-white rounded-2xl p-6 sm:p-8 max-w-md w-full">
                  <h3 className="text-xl sm:text-2xl font-bold mb-5 sm:mb-6 text-gray-800">Ajouter des Points</h3>
                  <div className="space-y-3 sm:space-y-4">
                    <button onClick={()=>addPts(sel,'fast')}
                      className="w-full flex items-center gap-3 bg-blue-50 hover:bg-blue-100 p-4 rounded-lg transition">
                      <span className="text-blue-600 text-xl">‚è±Ô∏è</span>
                      <div className="text-left flex-1">
                        <div className="font-bold text-blue-800">R√©ponse Rapide</div>
                        <div className="text-sm text-gray-600">+5 points (&lt;30min)</div>
                      </div>
                    </button>
                    <button onClick={()=>addPts(sel,'slow')}
                      className="w-full flex items-center gap-3 bg-green-50 hover:bg-green-100 p-4 rounded-lg transition">
                      <span className="text-green-600 text-xl">‚úîÔ∏è</span>
                      <div className="text-left flex-1">
                        <div className="font-bold text-green-800">R√©ponse Tardive</div>
                        <div className="text-sm text-gray-600">+3 points</div>
                      </div>
                    </button>
                    <button onClick={()=>addPts(sel,'challenge')}
                      className="w-full flex items-center gap-3 bg-purple-50 hover:bg-purple-100 p-4 rounded-lg transition">
                      <span className="text-purple-600 text-xl">üé¨</span>
                      <div className="text-left flex-1">
                        <div className="font-bold text-purple-800">D√©fi Pratique</div>
                        <div className="text-sm text-gray-600">+10 points</div>
                      </div>
                    </button>
                    <button onClick={()=>{ setShowAdd(false); setSel(null); }}
                      className="w-full bg-gray-200 hover:bg-gray-300 p-4 rounded-lg transition font-semibold">
                      Annuler
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Modal √©dition avanc√©e */}
            {mode==='admin' && showEdit && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
                <div className="bg-white rounded-2xl p-6 sm:p-8 max-w-md w-full">
                  <h3 className="text-xl sm:text-2xl font-bold mb-5 text-gray-800">Modifier le participant</h3>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Nom</label>
                      <input type="text" value={edit.name}
                        onChange={e => setEdit(prev => ({ ...prev, name: e.target.value }))}
                        className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="Nom du participant" />
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                      <div className="p-3 rounded-lg border">
                        <div className="text-sm text-gray-600 mb-1">R√©ponses rapides</div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => setEdit(prev => {
                            const v = Math.max(0, (parseInt(prev.fast,10) || 0) - 1);
                            const next = { ...prev, fast: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">‚àí</button>
                          <input type="number" min="0" value={edit.fast}
                            onChange={e => { const v = Math.max(0, parseInt(e.target.value,10) || 0);
                              const next = { ...edit, fast: v };
                              setEdit({ ...next, points: recomputePoints(next) });
                            }}
                            className="w-full px-2 py-1 border rounded text-center" />
                          <button onClick={() => setEdit(prev => {
                            const v = (parseInt(prev.fast,10) || 0) + 1;
                            const next = { ...prev, fast: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">+</button>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">√ó 5 pts</p>
                      </div>

                      <div className="p-3 rounded-lg border">
                        <div className="text-sm text-gray-600 mb-1">R√©ponses tardives</div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => setEdit(prev => {
                            const v = Math.max(0, (parseInt(prev.slow,10) || 0) - 1);
                            const next = { ...prev, slow: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">‚àí</button>
                          <input type="number" min="0" value={edit.slow}
                            onChange={e => { const v = Math.max(0, parseInt(e.target.value,10) || 0);
                              const next = { ...edit, slow: v };
                              setEdit({ ...next, points: recomputePoints(next) });
                            }}
                            className="w-full px-2 py-1 border rounded text-center" />
                          <button onClick={() => setEdit(prev => {
                            const v = (parseInt(prev.slow,10) || 0) + 1;
                            const next = { ...prev, slow: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">+</button>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">√ó 3 pts</p>
                      </div>

                      <div className="p-3 rounded-lg border">
                        <div className="text-sm text-gray-600 mb-1">D√©fis pratiques</div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => setEdit(prev => {
                            const v = Math.max(0, (parseInt(prev.chal,10) || 0) - 1);
                            const next = { ...prev, chal: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">‚àí</button>
                          <input type="number" min="0" value={edit.chal}
                            onChange={e => { const v = Math.max(0, parseInt(e.target.value,10) || 0);
                              const next = { ...edit, chal: v };
                              setEdit({ ...next, points: recomputePoints(next) });
                            }}
                            className="w-full px-2 py-1 border rounded text-center" />
                          <button onClick={() => setEdit(prev => {
                            const v = (parseInt(prev.chal,10) || 0) + 1;
                            const next = { ...prev, chal: v };
                            return { ...next, points: recomputePoints(next) };
                          })} className="px-2 py-1 rounded bg-gray-100">+</button>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">√ó 10 pts</p>
                      </div>
                    </div>

                    <div className="p-3 rounded-lg bg-gray-50 border">
                      <div className="text-sm text-gray-600">Total (recalcul√©)</div>
                      <div className="text-2xl font-bold text-gray-800">{recomputePoints(edit)} pts</div>
                      <p className="text-xs text-gray-500 mt-1">
                        Le total est automatiquement recalcul√© : 5√óRapides + 3√óTardives + 10√óD√©fis.
                      </p>
                    </div>

                    <div className="flex gap-2 pt-2">
                      <button onClick={saveEdit}
                        className="flex-1 bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 font-semibold transition">
                        Enregistrer
                      </button>
                      <button onClick={()=>setShowEdit(false)}
                        className="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2.5 rounded-lg font-semibold transition">
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
